# Playbook Builder Technical Design

## 1. Overview
The Playbook Builder is a strategic feature allowing sales teams to create, organize, and share comprehensive sales playbooks. Unlike the tactical `/talk-points` feature (which generates disposable, one-off call prep sheets), Playbooks are reusable assets containing multiple scenarios, structured content, and strategic guidance.

## 2. Data Models

### 2.1 Playbook Entity
Represents the top-level container for a sales strategy.

```python
class PlaybookStatus(str, Enum):
    DRAFT = "draft"
    PUBLISHED = "published"
    ARCHIVED = "archived"

class Playbook(BaseModel):
    id: str
    user_id: str
    title: str
    description: Optional[str]
    target_persona: Optional[str]
    industry: Optional[str]
    product_line: Optional[str]
    status: PlaybookStatus
    is_template: bool = False
    scenarios: List[Scenario] = []
    created_at: datetime
    updated_at: datetime
```

### 2.2 Scenario Entity
Represents a specific selling situation within a playbook (e.g., "Discovery Call with CTO").

```python
class Scenario(BaseModel):
    id: str
    playbook_id: str
    title: str  # e.g., "Discovery Call", "Technical Deep Dive"
    deal_stage: DealStage # Enum from existing session.py
    meeting_context: Optional[str]
    customer_pain_points: List[str]
    competitors: List[str]
    content_modules: ContentModules
```

### 2.3 Content Modules
Structured content sections generated by AI and editable by users.

```python
class ContentModules(BaseModel):
    opening_strategy: Optional[str]
    key_messages: List[str]
    value_propositions: List[str]
    discovery_questions: List[str]
    objection_handling: List[ObjectionResponse]
    next_steps: List[str]

class ObjectionResponse(BaseModel):
    objection: str
    response: str
```

## 3. API Design

### 3.1 Playbook Management
- `GET /api/playbooks`: List all playbooks (with filtering)
- `POST /api/playbooks`: Create a new empty playbook
- `GET /api/playbooks/{id}`: Get full playbook details
- `PUT /api/playbooks/{id}`: Update playbook metadata
- `DELETE /api/playbooks/{id}`: Delete a playbook

### 3.2 Scenario Management
- `POST /api/playbooks/{id}/scenarios`: Add a scenario to a playbook
- `PUT /api/playbooks/{id}/scenarios/{scenario_id}`: Update a scenario
- `DELETE /api/playbooks/{id}/scenarios/{scenario_id}`: Remove a scenario

### 3.3 AI Generation
- `POST /api/playbooks/generate`: Generate a full playbook structure based on high-level inputs
- `POST /api/playbooks/{id}/scenarios/generate`: Generate content for a specific scenario using RAG
  - **Inputs**: Playbook context + Scenario details
  - **Process**: 
    1. Retrieve relevant docs via RAG (product info, case studies)
    2. Construct prompt with context + RAG results
    3. Generate structured JSON content

## 4. Frontend Architecture

### 4.1 Pages
- `/playbooks` (Library): Grid view of playbooks, "Create New" button.
- `/playbooks/[id]` (Builder): Main editing interface.
  - **Left Sidebar**: Navigation (Metadata -> Scenario List).
  - **Main Content**: Form/Editor for the selected item.
  - **Right Sidebar (Optional)**: AI Assistant/Chat for refining content.

### 4.2 Components
- `PlaybookCard`: Summary display for library.
- `ScenarioEditor`: Complex form for editing scenario details.
- `ContentBlockEditor`: Rich text or structured input for specific modules (e.g., Objection/Response pairs).
- `GenerationControls`: UI for triggering AI generation (e.g., "Regenerate this section").

## 5. Implementation Plan

### Phase 1: Core Backend & Data (Days 1-2)
1. Define Pydantic models in `app/models/playbook.py`.
2. Create MongoDB collection `playbooks`.
3. Implement CRUD endpoints in `app/api/playbooks.py`.

### Phase 2: AI Services (Day 3)
1. Extend `OpenAIService` with `generate_playbook_structure` and `generate_scenario_content`.
2. Integrate `RagService` to pull context for scenario generation.

### Phase 3: Frontend Library & Structure (Days 4-5)
1. Create `/playbooks` page and API integration.
2. Create `/playbooks/[id]` shell and Metadata editor.

### Phase 4: Scenario Builder & Content (Days 6-8)
1. Implement Scenario management (Add/Edit/Delete).
2. Build content editors for `ContentModules`.
3. Connect "Generate with AI" buttons to backend.

### Phase 5: Polish & Refine (Days 9-10)
1. Export to PDF/Markdown.
2. UI improvements (loading states, error handling).
